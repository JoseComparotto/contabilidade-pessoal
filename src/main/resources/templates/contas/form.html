<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: commonHead(${mode} == 'edit' ? 'Editar Conta' : 'Nova Conta')}"></head>

<body>
    <div th:replace="~{fragments/toast :: toasts}"></div>
    <main class="container">
        <h1 th:text="${mode} == 'edit' ? 'Editar Conta' : 'Nova Conta'"></h1>

        <div class="controls" style="margin-bottom:1rem">
            <a href="/contas">← Voltar</a>
        </div>

        <div class="form-card">
            <!-- Create mode uses ContaNewDto; Edit mode uses ContaViewDto -->
            <form th:action="${mode} == 'edit' ? @{'/contas/' + ${conta.id} + '/edit'} : @{/contas}" method="post"
                th:with="
                    canEditDescricao=${mode == 'edit' ? conta.editableProperties.contains('descricao') : true},
                    isSelectDisabled=${mode == 'edit'},
                    canEditTipo=${mode == 'edit' ? conta.editableProperties.contains('tipo') : true},
                    canEditRedutora=${mode == 'edit' ? conta.editableProperties.contains('redutora') : true}
                ">
                <input type="hidden" name="redirect" th:value="${(mode == 'create' and conta.superiorId != null) ? '/contas/' + conta.superiorId : '/contas'}" />
                <div class="form-grid">

                    <!-- Código (somente edição, read-only) -->
                    <div class="field" th:if="${mode} == 'edit'">
                        <label for="codigo">Código</label>
                        <input id="codigo" name="codigo" type="text" th:value="${conta.codigo}" disabled />
                    </div>

                    <!-- Descrição -->
                    <div th:replace="~{fragments/form-controls :: textField(
                        'descricao', 'descricao', 'Descrição', ${conta.descricao},
                        true, ${not canEditDescricao}, 'Priorize o padrão Title Case: iniciais de cada palavra em maísculo.', true)
                    }"></div>

                    <!-- Conta superior -->
                    <div th:replace="~{fragments/form-controls :: selectField(
                        'superiorId', 'superiorId', 'Conta superior', ${contas}, ${mode == 'edit' ? conta.superior.id : conta.superiorId},
                        true, ${isSelectDisabled}, 'Selecione…', 'A nova conta será criada como filha da conta selecionada.', true)
                    }"></div>

                    <!-- Tipo de Conta (Segmentado) -->
                    <div th:replace="~{fragments/form-controls :: segmentedEnum(
                        'tipo', 'Tipo de Conta', ${tipos}, ${conta.tipo != null ? conta.tipo.name() : null}, 'TipoConta.',
                        true, ${not canEditTipo}, 'Dica: contas sintéticas podem ter contas filhas; contas analíticas podem receber lançamentos diretos.', true)
                    }"></div>

                    <!-- Redutora (checkbox) -->
                    <!-- Spring MVC field marker to coerce unchecked -> false -->
                    <input type="hidden" name="_redutora" value="on" />
                    <div th:replace="~{fragments/form-controls :: checkboxField(
                        'redutora', 'Redutora', ${conta.redutora != null ? conta.redutora : false}, ${not canEditRedutora}, 'Indica se a natureza da conta é oposta à raiz do grupo.', true)
                    }"></div>
                </div>

                <div th:replace="~{fragments/form-controls :: formActions(${mode} == 'edit' ? 'Salvar' : 'Criar', ${mode} == 'edit' ? '/contas/' + ${conta.id} : (${conta.superiorId} != null ? '/contas/' + ${conta.superiorId} : '/contas'))}"></div>
            </form>
        </div>
    </main>

    <script src="/js/toast.js"></script>
</body>

</html>